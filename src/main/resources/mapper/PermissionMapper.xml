<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="cn.kion.kionhub.mapper.PermissionMapper">
    <resultMap id="Permission" type="cn.kion.kionhub.entity.Permission">
        <id property="id" column="id"/>
        <result property="permissionCode" column="permission_code"/>
        <result property="permissionName" column="permission_name"/>
    </resultMap>
    <resultMap id="PathPermission" type="cn.kion.kionhub.entity.PathPermissionDO">
        <id property="id" column="id"/>
        <result property="url" column="url"/>
        <collection property="permissionList" ofType="cn.kion.kionhub.entity.Permission">
            <id property="id" column="pid"/>
            <result property="permissionCode" column="permission_code"/>
            <result property="permissionName" column="permission_name"/>
        </collection>
    </resultMap>
    <select id="selectListByPath" resultMap="Permission">
        SELECT p.* FROM sys_permission p
                    LEFT JOIN sys_request_path_permission_relation rp ON p.id = rp.permission_id
					LEFT JOIN sys_request_path r ON rp.url_id = r.id
					WHERE r.url = #{url};
    </select>

    <select id="selectAll" resultMap="PathPermission">
        SELECT r.id ,r.url,p.id as pid , p.permission_code,p.permission_name FROM sys_permission p
            LEFT JOIN sys_request_path_permission_relation rp ON p.id = rp.permission_id
			LEFT JOIN sys_request_path r ON rp.url_id = r.id
    </select>

    <select id="selectListByUser" resultMap="Permission">
				SELECT p.* FROM
					sys_permission p LEFT JOIN
					sys_role_permission_relation rp ON p.id=rp.permission_id LEFT JOIN
					sys_role r ON r.id=rp.role_id LEFT JOIN
					sys_user_role_relation ur ON ur.role_id=r.id LEFT JOIN
					sys_user u ON u.id=ur.user_id
					WHERE u.`name`=#{name}
    </select>

    <insert id="createPermission">
        INSERT INTO sys_permission(permission_code,permission_name)VALUES(#{permissionCode},#{permissionName});
    </insert>

    <delete id="delPermission">
        DELETE FROM sys_permission WHERE id = #{id};
    </delete>

    <insert id="createPath">
        INSERT INTO sys_request_path(url,description)VALUES(#{url},#{description});
    </insert>

    <delete id="delPath">
        DELETE FROM sys_request_path WHERE id = #{id};
    </delete>

    <insert id="setPathPermission">
        INSERT INTO sys_request_path_permission_relation(url_id,permission_id)VALUES(#{uid},#{pid});
    </insert>

    <delete id="delPathPermission">
        DELETE FROM sys_request_path_permission_relation WHERE url_id = uid AND permission_id = #{pid};
    </delete>
</mapper>